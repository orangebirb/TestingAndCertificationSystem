@model TestingAndCertificationSystem.ViewModels.QuestionDataModel

@{
    var qNum = "0";

    if (Context.Request.Query["questionNum"] != string.Empty)
    {
        qNum = Context.Request.Query["qNum"];
    }

    var testExpireTime = ((DateTime)ViewBag.EndTime);
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger" role="alert">
        @TempData["ErrorMessage"]
    </div>
}

<div class="row">
    <div class="col-md-12">
        <div class="card border-orange2">
            <ul class="list-group list-group-flush">
                <li class="list-group-item text-gradient-orange2"><h2>Question @qNum of @ViewBag.QuestionCount</h2></li>
                <li class="list-group-item">
                    <div>Time remaining: <span id="timer"></span></div>
                </li>
                <li class="list-group-item">
                    <p style="font-size: 20pt">
                        @Model.Question.Text
                    </p>
                </li>
                <form id="submitAnswForm" asp-action="SubmitAnswer" method="post" asp-route-token="@ViewBag.Token" asp-route-qNum="@qNum">
                    <li class="list-group-item">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <input asp-for="Question.Id" type="hidden" />

                        @switch (Model.Question.QuestionType)
                        {
                            case "RADIO":

                                @for (int i = 0; i < Model.Choices.Count(); i++)
                                {
                                    <input id="@Model.Choices[i].Choice.Id" value="true" type="radio" name="radio" />
                                    <label>@Model.Choices[i].Choice.Text</label>

                                    <input id="check_@Model.Choices[i].Choice.Id" asp-for="@Model.Choices[i].IsChecked" type="hidden" />
                                    <input asp-for="@Model.Choices[i].Choice.Id" type="hidden" />
                                    <br />
                                }
                                break;

                            case "CHECKBOX":

                                @for (int i = 0; i < Model.Choices.Count(); i++)
                                {
                                    <input type="checkbox" value="true" asp-for="Choices[i].IsChecked">
                                    <label>@Model.Choices[i].Choice.Text</label>
                                    <input asp-for="@Model.Choices[i].Choice.Id" type="hidden" />
                                    <br />
                                }
                                break;
                        }
                    </li>
                    <li class="list-group-item">
                        <div class="form-group">
                            <input id="CreateBtn" type="submit" value="Submit answer" class="btn btn-primary" onclick="SetAttr()" />
                        </div>
                    </li>
                    <li class="list-group">
                        <small class="text-muted" style="padding: 10px 0px;">&nbsp;&nbsp;&nbsp;&nbsp;If you have any questions about the test, contact test author: @ViewBag.TestAuthorEmail</small>
                    </li>
                </form>             
            </ul>
        </div>
    </div>
</div>

<script>
    function SetAttr() { //sets isChecked value to hidden form input

        var ds = document.getElementsByName('radio')

        for (var i = 0; i < ds.length; i++) {

            var el = document.getElementById('check_' + ds[i].id);
            document.getElementById(el.id).setAttribute('value', ds[i].checked);
        }
    }
</script>

<script>

    var time = setInterval(function () {

        var timeRemaining = new Date("@testExpireTime").getTime() - new Date().getTime();;

        var hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

        document.getElementById("timer").innerHTML = hours + " h "
            + minutes + " min " + seconds + " sec";

        if (timeRemaining < 0) {
            clearInterval(time);
            document.getElementById("timer").innerHTML = "EXPIRED";
            alert("time expired");
            window.location.href = "@Url.Action("TestResults", new { token = Context.Request.Query["token"]})";
        }
    }, 1000);
</script>
